---
title: "DEX 经典概念"
date: 2025-08-20
draft: false
tags: ["Web3", "DeFi"]
showToc: true
---

# 简介

AMM（Automated Market Maker，自动做市商）是一类无需订单簿、无需对手方撮合就能完成资产交换的机制。它通过一条**数学定价曲线**（例如最经典的恒定乘积公式 `x * y = k`）来确定池中两种资产的价格与兑换比例

交易者与 AMM 交互时，并不是与某个具体对手方进行买卖，而是与池子本身交易：

* 当交易者往池子中加入一种资产时，池子的储备量发生变化
* 定价曲线根据新储备自动给出另一种资产能取出的数量
* 由此实现“自动化报价”和“自动化执行”

---

## 1. 基本概念与不变式

* AMM 的核心思想：用一个**自动化的数学不变式**替代传统的订单簿，以池内储备（reserves）决定交易价格与数量。
* 最经典的不变式（恒定乘积）为：

```
x * y = k
```

其中 `x`、`y` 为池内两种资产的数量（reserve of X, reserve of Y），`k` 为常数（在无手续费的理想情况下保持不变）。

* 交易通过改变 `x` 或 `y` 的值来完成，新的 `x` 和 `y` 必须满足不变式（考虑手续费时，换入量先扣手续费再作用于不变式）

---

## 2. 交易定价与交换公式（恒定乘积，含手续费）

设池初始为 `x`（Token X）与 `y`（Token Y），不变式 `k = x * y`。有交易者向池中放入 `Δx`（交易量），手续费比例为 `f`（例如 0.003 = 0.3%）。实际用于保持不变式的增量为：

```
Δx_eff = Δx * (1 - f)
```

新的储备为：

```
x' = x + Δx_eff
y' = k / x'   （保持 x' * y' = k）
```

交易者能从池中取出的 Y 数量为：

```
Δy = y - y' = y - k / x'
```

下面给出一个具体数值示例，并逐步计算（按位计算以便核验）：

**示例参数**

* 初始：`x = 1000.0`、`y = 1000.0`
* 交易：`Δx = 10.0`（交易者放入 10 个 X）
* 手续费：`f = 0.003`（0.3%）

**步骤计算**

1. 计算不变式 `k`：`k = x * y = 1000.0 * 1000.0 = 1,000,000.0`
2. 计算有效交易量：`Δx_eff = Δx * (1 - f) = 10.0 * (1 - 0.003) = 10.0 * 0.997 = 9.97`
3. 计算新的 X 储备：`x' = x + Δx_eff = 1000.0 + 9.97 = 1009.97`
4. 计算新的 Y 储备：`y' = k / x' = 1,000,000.0 / 1009.97 ≈ 990.1284196560293`
   （计算拆解示意：1,000,000 ÷ 1009.97 ≈ 990.1284196560293）
5. 计算交易者得到的 Y：`Δy = y - y' = 1000.0 - 990.1284196560293 = 9.871580343970663`

结果表示：交易者用 10 个 X（支出 10 个 X）能换到约 `9.87158` 个 Y；其中手续费影响使得实际换出的量略小于 `Δx`

---

## 3. 价格、价格冲击与滑点

### 即时价格
在恒定乘积做市商中，池内 X 对 Y 的即时价格为：
```
p = y / x
```
其中 `p` 表示 1 单位 X 可兑换的 Y 数量。

### 交易对即时价格的影响
假设用户卖出 `Δx` 的 X 换取 Y（即用 X 买入 Y）：
- 初始储备：`(x, y)`，满足 `x * y = k`
- 交易后储备：`x' = x + Δx`，`y' = y - Δy`，仍满足 `x' * y' = k`

**交易后的即时价格**为：
```
p' = y' / x' = [k / (x + Δx)] / (x + Δx) = k / (x + Δx)²
```

**即时价格的比例变化**为：
```
p' / p = [k / (x + Δx)²] / (k / x²) = (x / (x + Δx))²
```

### 平均执行价格
实际交易中，价格冲击通常以**平均执行价格**与初始价格之比来衡量。

**定义**：
```
p_avg = Δy / Δx
```

根据恒定乘积公式 `Δy = y - k/(x + Δx)`，推导得：
```
p_avg = y / (x + Δx)
```
### 价格冲击
**定义**：
```
价格冲击 = 1 - p_avg / p = 1 - [y/(x+Δx)] / [y/x] = 1 - x/(x+Δx) = Δx/(x+Δx)
```

**近似**
对于小额交易（`Δx ≪ x`）：
```
价格冲击 ≈ Δx / x
```
即: **价格冲击与交易量相对于池中对应储备的比率成正比**

#### 关键结论
1. **即时价格变化**：交易后的即时价格变化为 `(x/x')²`，呈平方关系
2. **价格冲击计算**：实际价格冲击应基于**平均执行价格**，公式为 `Δx/(x+Δx)`
3. **近似关系**：当交易量相对较小时，价格冲击可近似为交易量占储备量的比例 `Δx/x`

#### 示例
假设池中储备：`x = 100` ETH，`y = 400,000` USDC（价格 `p = 4000` USDC/ETH）

- 卖出 1 ETH（`Δx = 1`）：
  - 精确价格冲击：`1/(100+1) ≈ 0.99%`
  - 近似价格冲击：`1/100 = 1%`
  
- 卖出 10 ETH（`Δx = 10`）：
  - 精确价格冲击：`10/(100+10) ≈ 9.09%`
  - 近似价格冲击：`10/100 = 10%`（误差增大）

这表明**大额交易会带来显著的非线性价格冲击**，是DEX设计中需要考虑的关键因素

### 滑点
**定义**:

滑点 = | (预期价格 - 实际成交价格) / 预期价格 | × 100%

*   **预期价格**：通常指交易发起时，用户基于当前池子状态（即时价格 `p = y / x`）估算出的价格。用户在钱包或交易界面设置的“最大滑点容忍度”就是指这个。
*   **实际成交价格**：即我们前面计算的**平均执行价格** `p_avg`。

#### 滑点与价格冲击的关系

这是最容易混淆的地方。它们紧密相关，但视角不同：

*   **价格冲击（Price Impact）** 是交易**行为本身对市场价格造成的影响**，是**原因**。它由池子公式和深度决定，是一个客观的、可计算的量。
    > 公式：`价格冲击 = 1 - p_avg / p`

*   **滑点（Slippage）** 是价格冲击在用户交易**执行结果上的体现**，是**结果**。它是用户主观预期（基于交易前价格）与客观结果（交易后平均价）的差值
    > 对于一笔导致价格冲击的交易，如果没有其他因素，那么 `滑点 ≈ 价格冲击`

#### 关键区别：滑点包含更广泛的因素

在真实链上环境中，**滑点 > 价格冲击**。因为滑点还包含了其他导致价格偏离的因素：

1.  **价格冲击**：你交易本身对池子的影响（最主要因素）。
2.  **区块等待期间的他人交易**：在你发送交易到交易被矿工/验证者打包进区块的几秒或十几秒内，池子状态可能已经被其他人的交易改变了。
3.  **三明治攻击等MEV**：搜索者可能通过夹心攻击（先买入推高价格，让你的交易在高位执行，再卖出获利）人为扩大你的滑点。

#### 实例说明

假设一个ETH/USDC池：
*   当前：`x = 100 ETH`, `y = 400,000 USDC` → 即时价格 `p = 4000 USDC/ETH`
*   你想用 `10 ETH` 购买 USDC。
*   不考虑他人交易和MEV。

**计算：**
*   **价格冲击** = `Δx / (x + Δx)` = `10 / (100 + 10)` ≈ **9.09%**
*   **平均执行价** `p_avg` = `y / (x + Δx)` = `400,000 / 110` ≈ `3636.36 USDC/ETH`
*   **理论滑点** = `(4000 - 3636.36) / 4000` ≈ **9.09%** （此时等于价格冲击）

**用户操作：**
你在钱包界面看到当前报价是 `4000 USDC/ETH`，你设置 **“最大滑点容忍度 = 10%”**。这意味着你接受的最差成交价不低于 `4000 * (1 - 10%) = 3600 USDC/ETH`

系统计算出你的交易将导致价格冲击约9.09%，平均执行价约为3636 USDC/ETH，**低于你设置的3600的底线**，因此交易可以正常提交

**真实链上情况：**
如果在你交易前，有人抢先买走了5个ETH，池子变为 `x = 95 ETH, y ≈ 380,000 USDC`，价格被拉高。这时你的10个ETH交易将面临**更大的价格冲击**，导致实际成交价可能低于3600 USDC，从而触发你设定的滑点保护，导致交易失败


## 4. 流动性提供者（LP）与 LP 代币

* LP 向池中存入两种资产以当前池中比率（例如在 50/50 池子中按当前价格等价金额）取得流动性份额（LP token）。
* LP token 的数量通常与存入的“价值比例”成正比，常见实现方式：

当池当前储备为 `x`、`y`，且总 LP 代币发行量为 `S`。若用户按比例存入 `Δx`、`Δy`，其中 `Δx / x = Δy / y = r`（即按当前比例存入），则铸造的 LP token 数量为：

```
ΔS = S * r = S * (Δx / x) = S * (Δy / y)
```

**示例**

* 假设当前 `x = 1000`，`y = 1000`，总 LP token `S = 1000`。一位 LP 想按池当前比例再存入 `Δx = 10`、`Δy = 10`。

* 计算比例 `r = Δx / x = 10 / 1000 = 0.01`。

* 则铸造的 LP token 为 `ΔS = S * r = 1000 * 0.01 = 10`。

* 赎回时，LP 持有 `s` 个 LP token（总量 `S`），可获得的池中资产为：

```
withdraw_x = x * (s / S)
withdraw_y = y * (s / S)
```

---

## 5. 暂时性损失（Impermanent Loss）——推导与数值示例

**定义（相对概念）**：当 LP 存入池中并等待价格变化时，与把两种资产直接持有相比，LP 在赎回时可能获得更低的法币价值；这种差额称为暂时性损失（IL）。称为“暂时性”是因为当价格回到原点时损失消失；但若 LP 在价格变化后退出，则损失成为永久损失。

**经典推导（价格变动因子设为 `r`，表示价格相对于初始翻倍的倍数）**

设初始价格为 `p0`，变动后价格为 `p1 = r * p0`。假设 LP 初始在价格 `p0` 下存入 `x0` 和 `y0`，且满足 `y0 = p0 * x0`（即两边初始等值）。不变式 `k = x0 * y0 = p0 * x0^2`。

价格变化后，由于 AMM 的恒定乘积及价比关系，有：

1. 新的 X 储备 `x1 = x0 / sqrt(r)`。推导要点：由 `x1 * y1 = k` 与 `y1 / x1 = r * p0 / p0 = r`（相对价格），可得到 `x1 = x0 / sqrt(r)`。
2. 新的 Y 储备 `y1 = y0 * sqrt(r)`（等价地 `y1 = sqrt(r) * p0 * x0`）。

LP 在新价格下的总价值为：

```
V_LP = x1 * p1 + y1 = 2 * p0 * x0 * sqrt(r)
```

而若原样持有（HODL）`x0` 和 `y0`，在新价格下的价值为：

```
V_HODL = x0 * p1 + y0 = p0 * x0 * (r + 1)
```

因此 LP 相对于持有的价值比为：

```
V_LP / V_HODL = (2 * sqrt(r)) / (r + 1)
```

由此得到 **暂时性损失**（以持有为基准的相对损失）：

```
IL(r) = 1 - (2 * sqrt(r)) / (r + 1)
```

**数值示例（价格翻倍 r = 2）**，逐步计算：

1. 计算 `sqrt(r)`：`sqrt(2) ≈ 1.4142135623730951`。
2. 计算 `2 * sqrt(r) ≈ 2 * 1.4142135623730951 = 2.8284271247461903`。
3. 计算 `r + 1 = 2 + 1 = 3`。
4. 计算比值 `(2 * sqrt(r)) / (r + 1) ≈ 2.8284271247461903 / 3 ≈ 0.9428090415820634`。
5. 计算 IL：`IL = 1 - 0.9428090415820634 = 0.0571909584179366`，约等于 **5.7191%**。

解释：当价格翻倍（上涨 100%）时，作为 LP 相较于直接持有两种资产，赎回时大约损失 5.72%（在没有手续费收益的假设下）。因此 LP 的手续费收入与其他激励需要超过该损失才能实现净收益。

---

## 6. 常见 AMM 变体（基础说明）

这里仅列出常见的基础模型，并给出核心差异，不涉及前沿扩展设计。

* **恒定乘积（Constant Product）**
  模型：`x * y = k`。优点：永远有价、实现简单；缺点：对大幅价格偏离产生显著 IL 与滑点。代表：Uniswap v2。

* **稳定币曲线（Stable Curve）**
  适用于价差极小或挂钩资产（如稳定币），该曲线在平衡点处斜率小、滑点低，但在极端偏离时会表现得像恒定乘积（曲线更“平坦”以减少小幅交易的滑点）。代表：Curve。

* **加权池（Weighted Pool）**
  允许两种或多种资产以非 50/50 权重存在（例如 80/20），用于构建指数化或加权投资篮子。代表：Balancer。

* **常数和（Constant Sum）**
  模型：`x + y = k`。优点：在价差极小的场景可提供最低滑点；缺点：不可提供无限流动性（当价差偏离时容易耗尽一边资产）。

---

## 7. 费用、收益分配与对 LP 的影响

* **交易手续费**：通常按比例从每笔交易中扣除（例如 0.3%）。手续费会计入池内，从而增加 LP 的资产总价值，分配给 LP 按份额比例。手续费是 LP 抵消暂时性损失的主要来源之一。
* **协议费**：部分协议会从手续费中抽取一部分作为协议方收益。
* **LP 净收益**：大致由三部分共同决定：交易量（带来手续费）、手续费率、以及 IL（随资产价格变动而产生）。若手续费收入覆盖 IL 与 gas 成本，LP 获得正收益。

---

## 8. 套利与价格一致性（基础）

* AMM 的即时链上价格可能偏离外部市场价。套利者通过在 AMM 与外部市场间交易（买便宜、卖昂贵）来获利。
* 这种套利行为把 AMM 的价格拉回外部市场价格，从而维持价格一致性。
* 套利为 AMM 带来手续费收入（对 LP 有利），但套利过程中可能产生 MEV（miner/extractor value）或前跑风险，这些属于链上交易排序层面的基础风险。

---

## 9. 基础风险（只列核心、常见项）

* **暂时性损失（IL）**：见上文推导。
* **滑点/大额交易带来的成本**：大交易会显著移动价格。
* **前跑（Front-running）与 MEV**：交易排序可能被优化者利用，导致普通用户或 LP 额外成本。
* **价格操纵（对依赖单一 on-chain 价格的策略）**：若策略直接使用 AMM 即时价格，可能被操控。
* **合约实现缺陷**：数值精度、边界条件、错误的铸币/赎回逻辑等都会带来资金风险。

---

## 10. 实践建议（面向入门者）

* 作为交易者：在交易前估算滑点和手续费；对大额交易分批或使用限价策略以降低冲击。
* 作为 LP：评估池子的历史交易量、手续费费率、资产波动性；低波动资产的池子通常 IL 更低；高交易量池子手续费收入更有可能覆盖 IL。
* 作为协议开发者：选择与目标资产匹配的曲线模型（stable vs volatile）；实现清晰且可验证的会计逻辑；对核心经济假设做压力测试。

---

如果需要，我可以把本节拆成几页，分别附上：

* 用于教学的交互式数值示例（JS/Python 脚本模拟恒定乘积池的交易与 IL 曲线）；或
* 更详细的 IL 曲线图表与不同 r 值下的表格（便于写进报告）。哪一种你想要我生成？
